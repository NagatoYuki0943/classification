https://mp.weixin.qq.com/s/yOt8YD4Q2IHfr0JX4ryT7A

https://blog.csdn.net/qq_37541097/article/details/126715733

è®ºæ–‡åç§°ï¼š**MobileViT: Light-Weight, General-Purpose, and Mobile-Friendly Vision Transformer**

è®ºæ–‡ä¸‹è½½åœ°å€ï¼šhttps://arxiv.org/abs/2110.02178

å®˜æ–¹æºç ï¼ˆPytorchå®ç°ï¼‰ï¼šhttps://github.com/apple/ml-cvnets

è‡ªå·±ä»ml-cvnetsä»“åº“ä¸­å‰¥ç¦»çš„ä»£ç ï¼šhttps://github.com/WZMIAOMIAO/deep-learning-for-image-processing/tree/master/pytorch_classification/MobileViT

## 0 å‰è¨€

è‡ªä»2020å¹´ViT(Vision Transformer)æ¨¡å‹çš„æ¨ªç©ºå‡ºä¸–ï¼Œäººä»¬å‘ç°äº†Transformeræ¶æ„åœ¨è§†è§‰é¢†åŸŸçš„å·¨å¤§æ½œåŠ›ã€‚è¿‘äº›å¹´ï¼Œè¶Šæ¥è¶Šå¤šçš„ç§‘ç ”äººå‘˜æŠ•å…¥Transformerçš„æ€€æŠ±ï¼Œè§†è§‰é¢†åŸŸçš„å„é¡¹ä»»åŠ¡ä¹Ÿä¸æ–­è¢«Transformeræ¶æ„æ¨¡å‹åˆ·æ–°ã€‚Transformerè™½ç„¶å¼ºå¤§ï¼Œä½†åœ¨ç°åœ¨çœ‹æ¥è½åœ°ä»å­˜åœ¨å¾ˆå¤šéš¾ç‚¹ã€‚æ¯”å¦‚æ¨¡å‹å‚æ•°å¤ªå¤§ï¼ˆæ¯”å¦‚ViT Large  Patch16æ¨¡å‹å…‰æƒé‡å°±æœ‰1ä¸ªå¤šGï¼‰ï¼Œè€Œä¸”ç®—åŠ›è¦æ±‚å¤ªé«˜ï¼Œè¿™åŸºæœ¬å°±ç»™ç§»åŠ¨ç«¯éƒ¨ç½²Transformeræ¨¡å‹åˆ¤äº†æ­»åˆ‘ã€‚

å°½ç®¡è¿‘ä¸¤å¹´Transformeræ¶æ„åœ¨è§†è§‰é¢†åŸŸå‡ºç°äº†å¾ˆå¤šä¼˜ç§€çš„å·¥ä½œï¼Œæ¯”å¦‚2021å¹´çš„Swin-Transformerï¼Œå®ƒç›¸æ¯”ViTæ•ˆæœæ›´å¥½ä¸”æ›´è½»é‡ï¼Œä½†ç›¸æ¯”åŸºäºCNNçš„è½»é‡çº§æ¨¡å‹ï¼ˆæ¯”å¦‚MobileNetç³»åˆ—ï¼‰æ— è®ºæ˜¯åœ¨æ¨¡å‹å‚æ•°ä¸Šè¿˜æ˜¯æ¨ç†é€Ÿåº¦ä¸Šéƒ½è¿˜æœ‰å¾ˆå¤§çš„å·®è·ã€‚å½“ç„¶æ¯•ç«ŸCNNä»2012å¹´çš„AlexNetå‘è¡¨è‡³ä»Šå·²ç»è¿‡å»10å¹´äº†ï¼Œæ— è®ºæ˜¯åœ¨æ¨¡å‹ç»“æ„çš„è®¾è®¡ä¸Šï¼Œè¿˜æ˜¯è½¯ç¡¬ä»¶çš„è°ƒä¼˜ä¸Šéƒ½å·²ç»ä¼˜åŒ–çš„éå¸¸åˆ°ä½äº†ã€‚

è€ŒTransformeræ¨¡å‹æ‰åˆšåˆšå¼€å§‹ï¼Œæˆ‘ç›¸ä¿¡å†è¿‡ä¸ªå‡ å¹´ï¼Œä¼šæœ‰è¶Šæ¥è¶Šå¤šçš„å­¦è€…ä»äº‹ç ”ç©¶Transformerè½»é‡åŒ–è®¾è®¡ï¼Œå¹¶ä¸”å„è½¯ç¡¬ä»¶å‚å•†ä¼šé’ˆå¯¹Transformeråšæ›´å¤šçš„ä¼˜åŒ–ï¼Œé‚£æ—¶Transformerè½åœ°ç§»åŠ¨ç«¯å°†ä¸å†æ˜¯é—®é¢˜ã€‚è¯é¢˜æ‰¯è¿œäº†ï¼Œè¨€å½’æ­£ä¼ ä»Šå¤©æˆ‘ä»¬æ¥ç®€å•èŠèŠMobileViTï¼ŒAppleå…¬å¸ï¼ˆå¯¹ï¼Œå°±æ˜¯é‚£ä¸ªè¢«å•ƒäº†ä¸€å£çš„è‹¹æœï¼‰åœ¨2021å¹´å‘è¡¨çš„ä¸€ç¯‡CNNä¸Transfomrerçš„æ··åˆæ¶æ„æ¨¡å‹ã€‚è¿‘ä¸¤å¹´CNNå’ŒTransformeræ··åˆæ¶æ„ç ”ç©¶ä¹Ÿæ˜¯ä¸€å¤§çƒ­ç‚¹ï¼ŒCNNçš„è½»é‡å’Œé«˜æ•ˆ+Transformerçš„è‡ªæ³¨æ„åŠ›æœºåˆ¶å’Œå…¨å±€è§†é‡ã€‚ä¸ºä»€ä¹ˆä¸ç”¨çº¯Transformeræ¶æ„ï¼Œå‰é¢æåˆ°äº†å®ƒå¾ˆâ€œé‡â€ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›å…¶ä»–çš„é—®é¢˜ï¼Œæ¯”å¦‚è¯´:

- Transformerç¼ºå°‘ç©ºé—´å½’çº³åç½®(spatial inductive biases)ã€‚è¿™ä¸ªä¹‹å‰åœ¨è®²Transformer  self-attentionæ—¶æœ‰æåˆ°è¿‡ã€‚è®¡ç®—æŸä¸ªtokençš„attentionæ—¶å¦‚æœå°†å…¶ä»–tokençš„é¡ºåºæ‰“ä¹±å¯¹æœ€ç»ˆç»“æœæ²¡æœ‰ä»»ä½•å½±å“ã€‚ä½†åœ¨å›¾åƒæ•°æ®ä¸­ï¼Œç©ºé—´ä¿¡æ¯æ˜¯å¾ˆé‡è¦ä¸”æœ‰æ„ä¹‰çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¸¸è§çš„æ–¹æ³•æ˜¯åŠ ä¸Šä½ç½®åç½®(position bias)/ä½ç½®ç¼–ç ï¼Œæ¯”å¦‚Vision Transformerä¸­ä½¿ç”¨çš„ç»å¯¹ä½ç½®åç½®ï¼ŒSwin Transformerä¸­çš„ç›¸å¯¹ä½ç½®åç½®ï¼ŒåŠ ä¸Šä½ç½®åç½®è™½ç„¶åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†ç©ºé—´ä½ç½®çš„ä¿¡æ¯ä¸¢å¤±çš„é—®é¢˜ï¼Œä½†åˆå¼•å…¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ã€‚è¿ç§»åˆ°åˆ«çš„ä»»åŠ¡ä¸Šæ—¶ï¼Œä½ç½®åç½®ä¿¡æ¯å¾€å¾€éœ€è¦è°ƒæ•´ã€‚
- Transformeræ¨¡å‹è¿ç§»åˆ°å…¶ä»–ä»»åŠ¡(è¾“å…¥å›¾åƒåˆ†è¾¨ç‡å‘ç”Ÿæ”¹å˜)æ—¶æ¯”è¾ƒç¹çã€‚è¿™é‡Œæ‰€è¯´çš„ç¹çæ˜¯ç›¸å¯¹CNNè€Œè¨€çš„ï¼Œè€Œä¸»è¦åŸå› æ˜¯å¼•å…¥ä½ç½®åç½®å¯¼è‡´çš„ã€‚æ¯”å¦‚åœ¨Imagenetä¸Šé¢„è®­ç»ƒå¥½çš„Vision Transformer(è¾“å…¥å›¾ç‰‡å¤§å°ä¸º`224x224`)æ¨¡å‹åï¼Œç°åœ¨è¦è¿ç§»åˆ°æ›´å¤§å°ºåº¦çš„ä»»åŠ¡ä¸­ï¼Œä½†ç”±äºVision Transformerçš„ç»å¯¹ä½ç½®åç½®çš„åºåˆ—é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œç­‰äº $\frac {H \times W} {16 \times 16}$ï¼Œå…¶ä¸­Hã€Wä»£è¡¨è¾“å…¥å›¾ç‰‡çš„é«˜å’Œå®½ï¼Œæ‰€ä»¥åªè¦æ”¹å˜è¾“å…¥å›¾åƒçš„å°ºåº¦å°±æ— æ³•ç›´æ¥å¤ç”¨äº†ã€‚ç°åœ¨æœ€å¸¸è§çš„å¤„ç†æ–¹æ³•æ˜¯é€šè¿‡æ’å€¼çš„æ–¹å¼å°†ä½ç½®ç¼–ç æ’å€¼åˆ°å¯¹åº”å›¾åƒçš„åºåˆ—é•¿åº¦ã€‚ä½†å¦‚æœä¸å¯¹ç½‘ç»œè¿›è¡Œå¾®è°ƒç›´æ¥ä½¿ç”¨å®é™…æ•ˆæœå¯èƒ½ä¼šæ‰ç‚¹ï¼Œæ¯”å¦‚åœ¨`224x224`å°ºåº¦ä¸Šè®­ç»ƒçš„ç½‘ç»œï¼Œç›´æ¥å¯¹ä½ç½®åç½®è¿›è¡Œæ’å€¼ä¸å»å¾®è°ƒï¼Œåœ¨`384x384`çš„å°ºåº¦ä¸Šè¿›è¡ŒéªŒè¯å¯èƒ½ä¼šå‡ºç°æ‰ç‚¹(CNNä¸€èˆ¬ä¼šæ¶¨ç‚¹)ã€‚å¦‚æœæ¯æ¬¡æ”¹å˜è¾“å…¥å›¾åƒå°ºåº¦éƒ½è¦é‡æ–°å¯¹ä½ç½®åç½®è¿›è¡Œæ’å€¼å’Œå¾®è°ƒï¼Œé‚£ä¹Ÿå¤ªéº»çƒ¦äº†ã€‚è¿™é‡Œæœ‰äººä¼šè¯´å¯ä»¥ä½¿ç”¨Swin Transformerä¸­çš„ç›¸å¯¹ä½ç½®åç½®ï¼Œç¡®å®å¦‚æ­¤ï¼ŒSwin Transformerç›¸å¯¹ä½ç½®åç½®çš„åºåˆ—é•¿åº¦åªå’ŒWindowså¤§å°æœ‰å…³ï¼Œä¸è¾“å…¥å›¾åƒå°ºåº¦æ— å…³ã€‚ä½†åœ¨å®é™…ä½¿ç”¨ä¸­ï¼ŒWindowsçš„å°ºåº¦å’Œè¾“å…¥å›¾åƒå°ºåº¦åˆæœ‰ä¸€å®šå…³ç³»ã€‚ä¸€èˆ¬è¾“å…¥å›¾åƒå°ºåº¦è¶Šå¤§ï¼ŒWindowsçš„å°ºåº¦ä¹Ÿä¼šè®¾ç½®çš„å¤§äº›ã€‚åªè¦Windowså°ºåº¦å‘ç”Ÿå˜åŒ–ï¼Œç›¸å¯¹ä½ç½®åç½®ä¹Ÿè¦è¿›è¡Œæ’å€¼äº†ï¼Œé‚£ä¹ˆé—®é¢˜åˆæ¥äº†ã€‚å½“ç„¶è¿™é‡Œå¹¶ä¸æ˜¯è¯´ä½ç½®åç½®å¼•å…¥äº†ä¸€å †é—®é¢˜å°±å»å¦å®šå®ƒçš„ä½œç”¨ï¼Œåªæ˜¯ç°åœ¨æ‰€é‡‡ç”¨çš„ä½ç½®åç½®æ–¹å¼è¿˜æœ‰å¾ˆå¤šå€¼å¾—ä¼˜åŒ–çš„åœ°æ–¹ã€‚æ¯”å¦‚åœ¨Swin Transformer v2ä¸­å°±å¯¹v1çš„ç›¸å¯¹ä½ç½®åç½®è¿›è¡Œäº†ä¼˜åŒ–ã€‚

- Transformeræ¨¡å‹è®­ç»ƒå›°éš¾ã€‚æ ¹æ®ç°æœ‰çš„ä¸€äº›ç»éªŒï¼ŒTransformerç›¸æ¯”CNNè¦æ›´éš¾è®­ç»ƒã€‚æ¯”å¦‚Transformeréœ€è¦æ›´å¤šçš„è®­ç»ƒæ•°æ®ï¼Œéœ€è¦è¿­ä»£æ›´å¤šçš„epochï¼Œéœ€è¦æ›´å¤§çš„æ­£åˆ™é¡¹(L2æ­£åˆ™)ï¼Œéœ€è¦æ›´å¤šçš„æ•°æ®å¢å¼º(ä¸”å¯¹æ•°æ®å¢å¼ºå¾ˆæ•æ„Ÿï¼Œæ¯”å¦‚åœ¨MobileViTè®ºæ–‡çš„å¼•è¨€ä¸­æåˆ°ï¼Œå¦‚æœå°†CutMixä»¥åŠDeIT-styleçš„æ•°æ®å¢å¼ºç§»é™¤ï¼Œæ¨¡å‹åœ¨Imagenetä¸Šçš„Accç›´æ¥æ‰6ä¸ªç‚¹)ã€‚

> é’ˆå¯¹ä»¥ä¸Šé—®é¢˜ï¼Œç°æœ‰çš„ã€æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯é‡‡ç”¨CNNä¸Transformerçš„æ··åˆæ¶æ„ï¼ŒCNNèƒ½å¤Ÿæä¾›ç©ºé—´å½’çº³åç½®æ‰€ä»¥å¯ä»¥æ‘†è„±ä½ç½®åæ‰§ï¼Œè€Œä¸”åŠ å…¥CNNåèƒ½å¤ŸåŠ é€Ÿç½‘ç»œçš„æ”¶æ•›ï¼Œä½¿ç½‘ç»œè®­ç»ƒè¿‡ç¨‹æ›´åŠ çš„ç¨³å®šã€‚ä¸‹å›¾å±•ç¤ºäº†MobileViTä¸å½“æ—¶ä¸»æµçš„ä¸€äº›Transformeræ¨¡å‹å¯¹æ¯”ï¼Œé€šè¿‡ä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼Œå³ä½¿ä½¿ç”¨æ™®é€šçš„æ•°æ®å¢å¼ºæ–¹å¼MobileViTä¹Ÿèƒ½è¾¾åˆ°æ›´é«˜çš„Accå¹¶ä¸”å‚æ•°æ•°é‡æ›´å°‘ã€‚

![image-20220906184105709](2110.02178 MobileViT.assets/å¯¹æ¯”Vit.png)

é™¤æ­¤ä¹‹å¤–ï¼Œä½œè€…è¿˜å°†MobileViTä¸ä¸€äº›ä¼ ç»Ÿçš„è½»é‡çº§CNNè¿›è¡Œäº†å¯¹æ¯”ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨è¿‘ä¼¼çš„å‚æ•°æ•°é‡ä¸‹MobileViTçš„Accè¦æ›´é«˜ã€‚

![image-20220906183507844](2110.02178 MobileViT.assets/æ€§èƒ½.png)

ä»¥ä¸Šåªæåˆ°äº†å‚æ•°æ•°é‡å’ŒAccï¼Œå¹¶æ²¡æœ‰æ˜ç¡®çš„æ¨ç†é€Ÿåº¦å¯¹æ¯”ï¼Œåœ¨è®ºæ–‡ä¸­å”¯ä¸€èƒ½æ‰¾åˆ°çš„ä¸€ä¸ªæœ‰æ¨ç†é€Ÿåº¦å¯¹æ¯”æ˜¯è¡¨3ï¼Œé€šè¿‡å¯¹æ¯”èƒ½å¤Ÿçœ‹åˆ°åŸºäºTranaformerçš„æ¨¡å‹(æ— è®ºæ˜¯å¦ä¸ºæ··åˆæ¶æ„)æ¨ç†é€Ÿåº¦æ¯”çº¯CNNçš„æ¨¡å‹è¿˜æ˜¯è¦æ…¢å¾ˆå¤šçš„(ç§»åŠ¨ç«¯)ã€‚ä½œè€…åœ¨è®ºæ–‡ä¸­ç»™å‡ºè§£é‡Šä¸»è¦è¿˜æ˜¯è¯´å½“å‰ç§»åŠ¨ç«¯å¯¹Transformeræ¶æ„ä¼˜åŒ–çš„è¿˜å¤ªå°‘ã€‚

![image-20220906183608809](2110.02178 MobileViT.assets/æ¨ç†é€Ÿåº¦.png)



## 1 æ¨¡å‹ç»“æ„è§£æ

### 1.1 Vision Transformerç»“æ„

åœ¨è®²MobileViTç½‘ç»œä¹‹å‰å…ˆç®€å•å›é¡¾ä¸‹Vision Transformerçš„ç½‘ç»œç»“æ„ï¼Œå¦‚æœè¿˜ä¸äº†è§£ï¼Œå»ºè®®å…ˆçœ‹ä¸‹ä¹‹å‰å†™çš„æœ‰å…³Vision  Transformerçš„æ–‡ç« ï¼šhttps://blog.csdn.net/qq_37541097/article/details/118242600ã€‚ä¸‹å›¾æ˜¯MobileViTè®ºæ–‡ä¸­ç»˜åˆ¶çš„`Standard visual Transformer`ã€‚é¦–å…ˆå°†è¾“å…¥çš„å›¾ç‰‡åˆ’åˆ†æˆä¸€ä¸ªä¸ª`Patch`ï¼Œç„¶åé€šè¿‡çº¿æ€§å˜åŒ–å°†æ¯ä¸ª`Patch`æ˜ å°„åˆ°ä¸€ä¸ªä¸€ç»´å‘é‡ä¸­ï¼ˆè§†ä¸ºä¸€ä¸ªä¸ª`Token`ï¼‰ï¼Œæ¥ç€åŠ ä¸Šä½ç½®åç½®ä¿¡æ¯ï¼ˆå¯å­¦ä¹ å‚æ•°ï¼‰ï¼Œå†é€šè¿‡ä¸€ç³»åˆ—Transformer Blockï¼Œæœ€åé€šè¿‡ä¸€ä¸ªå…¨è¿æ¥å±‚å¾—åˆ°æœ€ç»ˆé¢„æµ‹è¾“å‡ºã€‚

![image-20220906183137435](2110.02178 MobileViT.assets/Vision Transformerç»“æ„.png)

### 1.2 MobileViTç»“æ„

ç®€å•å›é¡¾å®ŒVision Transformeråï¼Œå†æ¥çœ‹çœ‹æœ¬æ–‡è¦è®²çš„MobileViTã€‚ä¸‹å›¾å¯¹åº”çš„æ˜¯è®ºæ–‡ä¸­çš„å›¾1(b)ï¼Œé€šè¿‡ä¸‹å›¾å¯ä»¥çœ‹åˆ°MobileViTä¸»è¦ç”±æ™®é€šå·ç§¯ï¼Œ`MV2`ï¼ˆMobiletNetV2ä¸­çš„`Inverted Residual block`ï¼‰ï¼Œ`MobileViT block`ï¼Œå…¨å±€æ± åŒ–ä»¥åŠå…¨è¿æ¥å±‚å…±åŒç»„æˆã€‚

![image-20220906183246002](2110.02178 MobileViT.assets/MobileViTç»“æ„.png)



> å…³äº`MV2`ç»“æ„ä¹‹å‰åœ¨è®²MobileNetV2æ—¶æœ‰è®²è¿‡ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œä¸‹å›¾æ˜¯å½“strideç­‰äº1æ—¶çš„`MV2`ç»“æ„ã€‚ä¸Šå›¾ä¸­æ ‡æœ‰å‘ä¸‹ç®­å¤´çš„`MV2`ç»“æ„ä»£è¡¨strideç­‰äº2çš„æƒ…å†µï¼Œå³éœ€è¦è¿›è¡Œä¸‹é‡‡æ ·ã€‚
>
> 1x1Convæé«˜é€šé“æ•°ä¸º6å€ï¼Œ3x3DWConvæå–ç‰¹å¾ï¼Œ1x1Convè¿˜åŸé€šé“æ•°

![image-20220906080631881](2110.02178 MobileViT.assets/MobileNetV2ç»“æ„.png)

> æ¥ä¸‹æ¥å°±æ˜¯æœ€æ ¸å¿ƒçš„`MobileViT block`ï¼Œåœ¨è®ºæ–‡çš„å›¾1(b)ä¸­ä½œè€…å·²ç»ç»˜åˆ¶å‡ºäº†`MobileViT block`çš„å¤§è‡´ç»“æ„ã€‚é¦–å…ˆå°†ç‰¹å¾å›¾é€šè¿‡ä¸€ä¸ªå·ç§¯æ ¸å¤§å°ä¸º`nxn`ï¼ˆä»£ç ä¸­æ˜¯`3x3`ï¼‰çš„å·ç§¯å±‚è¿›è¡Œå±€éƒ¨çš„ç‰¹å¾å»ºæ¨¡ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå·ç§¯æ ¸å¤§å°ä¸º`1x1`çš„å·ç§¯å±‚è°ƒæ•´é€šé“æ•°ã€‚æ¥ç€é€šè¿‡`Unfold -> Transformer -> Fold`ç»“æ„è¿›è¡Œå…¨å±€çš„ç‰¹å¾å»ºæ¨¡ï¼Œç„¶åå†é€šè¿‡ä¸€ä¸ªå·ç§¯æ ¸å¤§å°ä¸º`1x1`çš„å·ç§¯å±‚å°†é€šé“æ•°è°ƒæ•´å›åŸå§‹å¤§å°ã€‚æ¥ç€é€šè¿‡shortcutæ·å¾„åˆ†æ”¯ä¸åŸå§‹è¾“å…¥ç‰¹å¾å›¾è¿›è¡Œ`Concat`æ‹¼æ¥ï¼ˆæ²¿é€šé“channelæ–¹å‘æ‹¼æ¥ï¼‰ï¼Œæœ€åå†é€šè¿‡ä¸€ä¸ªå·ç§¯æ ¸å¤§å°ä¸º`nxn`ï¼ˆä»£ç ä¸­æ˜¯`3x3`ï¼‰çš„å·ç§¯å±‚åšç‰¹å¾èåˆå¾—åˆ°è¾“å‡ºã€‚

![image-20220906183413474](2110.02178 MobileViT.assets/MobileViTç»“æ„1.png)

> æˆ‘ä¸ªäººè®¤ä¸ºæœ‰å…³`Unfold -> Transformer -> Fold`è¿™å—ä»‹ç»çš„å¹¶ä¸æ˜¯å¾ˆæ¸…æ¥šï¼ˆå¯èƒ½æ˜¯æˆ‘å¤ªèœï¼‰ï¼Œæ‰€ä»¥çœ‹äº†ä¸‹æºç è‡ªå·±é‡æ–°ç»˜åˆ¶äº†ä¸€ä¸ªæ–¹ä¾¿å¤§å®¶ç†è§£çš„ç‰ˆæœ¬ã€‚
>
> è¿™é‡Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å°†`Unfold -> Transformer -> Fold`ç®€å†™æˆ`Global representations`ï¼Œå®ƒçš„å…·ä½“è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
>
> é¦–å…ˆå¯¹ç‰¹å¾å›¾åˆ’åˆ†`Patch`ï¼ˆè¿™é‡Œä¸ºäº†æ–¹ä¾¿å¿½ç•¥é€šé“channelsï¼‰ï¼Œå›¾ä¸­çš„`Patch`å¤§å°ä¸º`2x2`ï¼Œå³æ¯ä¸ª`Patch`ç”±4ä¸ª`Pixel`ç»„æˆã€‚åœ¨è¿›è¡Œ`Self-Attention`è®¡ç®—çš„æ—¶å€™ï¼Œæ¯ä¸ª`Token`ï¼ˆå›¾ä¸­çš„æ¯ä¸ª`Pixel`æˆ–è€…è¯´æ¯ä¸ªå°é¢œè‰²å—ï¼‰åªå’Œè‡ªå·±é¢œè‰²ç›¸åŒçš„`Token`è¿›è¡Œ`Attention`ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†å‡å°‘è®¡ç®—é‡çš„ç›®çš„ï¼Œæ²¡é”™å°±è¿™ä¹ˆç®€å•ã€‚
>
> å¯¹äºåŸå§‹çš„`Self-Attention`è®¡ç®—æ¯ä¸ª`Token`æ˜¯éœ€è¦å’Œæ‰€æœ‰çš„`Token`è¿›è¡Œ`Attention`ï¼Œå‡è®¾ç‰¹å¾å›¾çš„é«˜å®½å’Œé€šé“æ•°åˆ†åˆ«ä¸º`H, W, C`ï¼Œè¿™é‡Œè®°è®¡ç®—æˆæœ¬ä¸º`Cost=O(WHC)`ã€‚
>
> `[b, position, channel] @ [b, channel, position] ä»å‰é¢ä¸€ä¸ªçš„positionæ¥çœ‹,ä¸€è¡Œä»£è¡¨ä¸€ä¸ªposition,å®ƒä¼šä¹˜ä»¥åé¢çš„æ¯ä¸€åˆ—,åé¢çš„åˆ—ä¹Ÿæ˜¯position,å°±æ„å‘³ç€æ±‚ä½ç½®ä¹‹é—´çš„ç›¸ä¼¼åº¦`
>
> å¦‚æœæŒ‰ç…§åˆšåˆšè¯´çš„ï¼Œæ¯ä¸ª`Token`åªå’Œè‡ªå·±é¢œè‰²ç›¸åŒçš„`Token`åš`Attention`ï¼Œå‡è®¾`Patch`å¤§å°ä¸º`2x2`ï¼Œè®¡ç®—æ—¶é«˜å®½å’Œé€šé“æ•°åˆ†åˆ«ä¸º`H/2, W/2, C`ï¼Œé‚£ä¹ˆè®¡ç®—æˆæœ¬ä¸º`Cost=O(WHC/4)`ï¼Œå³ç†è®ºä¸Šçš„è®¡ç®—æˆæœ¬ä»…ä¸ºåŸå§‹çš„ $\frac 1 4$ã€‚
>
> è‡³äºä¸ºä»€ä¹ˆèƒ½è¿™ä¹ˆåšï¼Œè¿™é‡Œç®€å•è°ˆè°ˆæˆ‘çš„çœ‹æ³•ã€‚å¯¹äºå›¾åƒæ•°æ®æœ¬èº«å°±å­˜åœ¨å¤§é‡çš„æ•°æ®å†—ä½™ï¼Œæ¯”å¦‚å¯¹äºè¾ƒæµ…å±‚çš„ç‰¹å¾å›¾ï¼ˆ`H, W`ä¸‹é‡‡æ ·å€ç‡è¾ƒä½æ—¶ï¼‰ï¼Œç›¸é‚»åƒç´ é—´ä¿¡æ¯å¯èƒ½æ²¡æœ‰å¤ªå¤§å·®å¼‚ï¼Œå¦‚æœæ¯ä¸ª`Token`åš`Attention`çš„æ—¶å€™éƒ½è¦å»çœ‹ä¸‹ç›¸é‚»çš„è¿™äº›åƒç´ ï¼Œä¸ªäººæ„Ÿè§‰æœ‰äº›æµªè´¹ç®—åŠ›ã€‚è¿™é‡Œå¹¶ä¸æ˜¯è¯´çœ‹ç›¸é‚»çš„åƒç´ æ²¡æœ‰æ„ä¹‰ï¼Œåªæ˜¯è¯´åœ¨åˆ†è¾¨ç‡è¾ƒé«˜çš„ç‰¹å¾å›¾ä¸Šæ”¶ç›Šå¯èƒ½å¾ˆä½ï¼Œå¢åŠ çš„è®¡ç®—æˆæœ¬è¿œå¤§äºAccuracyä¸Šçš„æ”¶ç›Šã€‚è€Œä¸”å‰é¢å·²ç»é€šè¿‡`nxn`çš„å·ç§¯å±‚è¿›è¡Œå±€éƒ¨å»ºæ¨¡äº†ï¼Œè¿›è¡Œå…¨å±€å»ºæ¨¡æ—¶å°±æ²¡å¿…è¦å†çœ‹è¿™ä¹ˆç»†äº†ã€‚
>
> å‡è®¾å®½é«˜ä¸º14,åˆ™æœ‰196ä¸ªpatch,å¯¹äºåŸå§‹çš„`Self-Attention`è®¡ç®—ä¸º `[B, 196, C] @ [B, C, 196] @ [b, 196, C]` ä¸­ `196*196*C=38416C`
>
> åˆ’åˆ†ä¸º2x2åè®¡ç®— `Attention` `[B, 49, C] @ [B, C, 49] @ [B, 49, C]` ä¸­  `49*49*4*C=9604C`

![image-20220906080652128](2110.02178 MobileViT.assets/unfold.png)

> è€Œåˆšåˆšæåˆ°çš„`Unfold`å’Œ`Fold`åªæ˜¯ä¸ºäº†å°†æ•°æ®ç»™reshapeæˆè®¡ç®—`Self-Attention`æ—¶æ‰€éœ€çš„æ•°æ®æ ¼å¼ã€‚å¯¹äºæ™®é€šçš„`Self-Attention`è®¡ç®—å‰ï¼Œä¸€èˆ¬æ˜¯ç›´æ¥å±•å¹³`H, W`ä¸¤ä¸ªç»´åº¦å¾—åˆ°ä¸€ä¸ª`Token`åºåˆ—ï¼Œå³å°†`[N, H, W, C] -> [N, H*W, C]`å…¶ä¸­Nè¡¨ç¤ºBatchç»´åº¦ã€‚
>
> ä½†åœ¨`MobileViT block`çš„`Self-Attention`è®¡ç®—ä¸­ï¼Œåªæ˜¯å°†é¢œè‰²ç›¸åŒçš„`Token`è¿›è¡Œäº†`Attention`ï¼Œæ‰€ä»¥ä¸èƒ½ç®€å•ç²—æš´çš„å±•å¹³`H, W`ç»´åº¦ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ–‡ä¸­çš„`Unfold`å°±æ˜¯å°†ç›¸åŒé¢œè‰²çš„`Token`å±•å¹³åœ¨ä¸€ä¸ªåºåˆ—ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥ä½¿ç”¨æ™®é€šçš„`Self-Attention`å¹¶è¡Œè®¡ç®—æ¯ä¸ªåºåˆ—çš„`Attention`äº†ã€‚æœ€åå†é€šè¿‡`Fold`æŠ˜å å›åŸç‰¹å¾å›¾å³å¯ã€‚

![å›¾ç‰‡](2110.02178 MobileViT.assets/unfolid&fold.png)

### 1.3 Patch Sizeå¯¹æ€§èƒ½çš„å½±å“

> åœ¨ä¸Šé¢1.2ç« èŠ‚ä¸­æˆ‘ä»¬å·²ç»è®²å®Œäº†MobileViTç»“æ„ï¼Œæ¥ç€æˆ‘ä»¬å†æ¥èŠèŠæœ‰å…³`patch_size`å¯¹ç½‘ç»œæ€§èƒ½çš„å½±å“ã€‚å‰é¢æœ‰æåˆ°å¤§çš„`patch_size`èƒ½å¤Ÿæå‡ç½‘ç»œæ¨ç†é€Ÿåº¦ï¼Œä½†æ˜¯ä¼šä¸¢å¤±ä¸€äº›ç»†èŠ‚ä¿¡æ¯ã€‚è¿™é‡Œç›´æ¥çœ‹ä¸‹è®ºæ–‡ä¸­ç»™çš„å›¾8ï¼Œè¿™é‡Œå±•ç¤ºäº†ä¸¤ç»„ä¸åŒçš„`patch_size`ç»„åˆåœ¨ä¸‰ä¸ªä»»åŠ¡ä¸­çš„æ€§èƒ½ï¼ŒåŒ…æ‹¬å›¾åƒåˆ†ç±»ï¼Œç›®æ ‡æ£€æµ‹ä»¥åŠè¯­ä¹‰åˆ†å‰²ã€‚å…¶ä¸­é…ç½®Açš„`patch_size`ä¸º`{2, 2, 2}`ï¼Œé…ç½®Bçš„`patch_size`ä¸º`{8, 4, 2}`ï¼Œè¿™ä¸‰ä¸ªæ•°å­—åˆ†åˆ«å¯¹åº”ä¸‹é‡‡æ ·å€ç‡ä¸º8ï¼Œ16ï¼Œ32çš„ç‰¹å¾å›¾æ‰€é‡‡ç”¨çš„`patch_size`å¤§å°ã€‚é€šè¿‡å¯¹æ¯”å¯ä»¥å‘ç°ï¼Œåœ¨å›¾åƒåˆ†ç±»å’Œç›®æ ‡æ£€æµ‹ä»»åŠ¡ä¸­ï¼ˆå¯¹è¯­ä¹‰ç»†èŠ‚è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼‰ï¼Œé…ç½®Aå’Œé…ç½®Båœ¨Accå’ŒmAPä¸Šæ²¡å¤ªå¤§åŒºåˆ«ï¼Œä½†é…ç½®Bè¦æ›´å¿«ã€‚ä½†åœ¨è¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸­ï¼ˆå¯¹è¯­ä¹‰ç»†èŠ‚è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼‰é…ç½®Açš„æ•ˆæœè¦æ›´å¥½ã€‚

![image-20220906183923687](2110.02178 MobileViT.assets/Patch Sizeå¯¹æ€§èƒ½çš„å½±å“.png)



## 2 æ¨¡å‹è¯¦ç»†é…ç½®

> åœ¨è®ºæ–‡ä¸­ï¼Œå…³äºMobileViTä½œè€…æå‡ºäº†ä¸‰ç§ä¸åŒçš„é…ç½®ï¼Œåˆ†åˆ«æ˜¯MobileViT-S(small)ï¼ŒMobileViT-XS(extra small)å’ŒMobileViT-XXS(extra extra  small)ã€‚ä¸‰è€…çš„ä¸»è¦åŒºåˆ«åœ¨äºç‰¹å¾å›¾çš„é€šé“æ•°ä¸åŒã€‚ä¸‹å›¾ä¸ºMobileViTçš„æ•´ä½“æ¡†æ¶ï¼Œæœ€å¼€å§‹çš„`3x3`å·ç§¯å±‚ä»¥åŠæœ€åçš„`1x1`å·ç§¯å±‚ã€å…¨å±€æ± åŒ–ã€å…¨è¿æ¥å±‚ä¸å»èµ˜è¿°ï¼Œä¸»è¦çœ‹ä¸‹å›¾ä¸­çš„æ ‡å‡ºçš„Layer1~5ï¼Œè¿™é‡Œæ˜¯æ ¹æ®æºç ä¸­çš„é…ç½®ä¿¡æ¯åˆ’åˆ†çš„ã€‚ä¸‹é¢åªåˆ—ä¸¾äº†éƒ¨åˆ†é…ç½®ä¿¡æ¯ï¼Œæ›´åŠ è¯¦ç»†çš„é…ç½®å¯æŸ¥çœ‹æºç ã€‚

![image-20220906080724330](2110.02178 MobileViT.assets/æ¨¡å‹è¯¦ç»†é…ç½®.png)

å…¶ä¸­ï¼š

- `in/out_channels`è¡¨ç¤ºè¯¥æ¨¡å—è¾“å…¥/è¾“å‡ºçš„é€šé“æ•°
- `mv2_exp_ratio`è¡¨ç¤º`Inverted Residual Block`ä¸­çš„expansion ratio
- `transformer_channels`è¡¨ç¤º`Transformer`æ¨¡å—è¾“å…¥`Token`çš„åºåˆ—é•¿åº¦ï¼ˆç‰¹å¾å›¾é€šé“æ•°ï¼‰,é€šé“å˜åŒ–ä¸º `[N, P, C] -> [N, h, P, c] @ [N, h, c, P] @ [N, h, P, c] = [N, P, C]`
- `num_heads`è¡¨ç¤ºå¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­çš„headæ•°
- `ffn_dim`è¡¨ç¤ºFFNä¸­é—´å±‚`Token`çš„åºåˆ—é•¿åº¦ï¼Œä»ä¸‹è¡¨å¯ä»¥çœ‹åˆ°ç›¸æ¯”è¾“å…¥çš„`channel`ç¿»å€ï¼Œå› æ­¤ffné€šé“å˜åŒ–ä¸º`[N, P, C] -> [N, P, 2C] -> [N, P, C]`
- `patch_h`è¡¨ç¤ºæ¯ä¸ªpatchçš„é«˜åº¦
- `patch_w`è¡¨ç¤ºæ¯ä¸ªpatchçš„å®½åº¦

å¯¹äºMobileViT-XXSï¼ŒLayer1~5çš„è¯¦ç»†é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š

| layer  | in/out_channels | mv2_exp_ratio | transformer_channels | ffn_dim | patch_h | patch_w | num_heads |
| :----- | :-------------- | :------------ | :------------------- | :------ | :------ | :------ | :-------- |
| layer1 | 16              | 2             | None                 | None    | None    | None    | None      |
| layer2 | 24              | 2             | None                 | None    | None    | None    | None      |
| layer3 | 48              | 2             | 64                   | 128     | 2       | 2       | 4         |
| layer4 | 64              | 2             | 80                   | 160     | 2       | 2       | 4         |
| layer5 | 80              | 2             | 96                   | 192     | 2       | 2       | 4         |

å¯¹äºMobileViT-XSï¼ŒLayer1~5çš„è¯¦ç»†é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š

| layer  | in/out_channels | mv2_exp_ratio | transformer_channels | ffn_dim | patch_h | patch_w | num_heads |
| :----- | :-------------- | :------------ | :------------------- | :------ | :------ | :------ | :-------- |
| layer1 | 32              | 4             | None                 | None    | None    | None    | None      |
| layer2 | 48              | 4             | None                 | None    | None    | None    | None      |
| layer3 | 64              | 4             | 96                   | 192     | 2       | 2       | 4         |
| layer4 | 80              | 4             | 120                  | 240     | 2       | 2       | 4         |
| layer5 | 96              | 4             | 144                  | 288     | 2       | 2       | 4         |

å¯¹äºMobileViT-Sï¼ŒLayer1~5çš„è¯¦ç»†é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š

| layer  | in/out_channels | mv2_exp_ratio | transformer_channels | ffn_dim | patch_h | patch_w | num_heads |
| :----- | :-------------- | :------------ | :------------------- | :------ | :------ | :------ | :-------- |
| layer1 | 32              | 4             | None                 | None    | None    | None    | None      |
| layer2 | 64              | 4             | None                 | None    | None    | None    | None      |
| layer3 | 96              | 4             | 144                  | 288     | 2       | 2       | 4         |
| layer4 | 128             | 4             | 192                  | 384     | 2       | 2       | 4         |
| layer5 | 160             | 4             | 240                  | 480     | 2       | 2       | 4         |

------

åˆ°æ­¤ï¼Œæœ‰å…³MobileViTçš„å†…å®¹å°±åŸºæœ¬è®²å®Œäº†ã€‚å¦‚æœè§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰ç”¨ï¼Œè®°å¾—ç‚¹èµã€æ”¶è—å¹¶åˆ†äº«ç»™ä½ çš„å°ä¼™ä¼´ä»¬å“¦ğŸ˜„ã€‚